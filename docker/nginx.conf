# nginx/nginx.conf
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    # 安全静态资源服务
    server {
        listen 80;
        server_name localhost;

        # 公开路径：/blobs/... → 对应内部 /var/www/private/uploads/...
        location /blobs/ {
            # 启用 secure_link 模块
            # URL 格式: /blobs/xxx?token=ENCODED_MD5&expire=TIMESTAMP
            secure_link $arg_token,$arg_expire;
            secure_link_md5 "$secure_link_expires$uri$remote_addr pubchat_access_private_key";

            # 验证失败：token 无效
            if ($secure_link = "") {
                return 403;
            }

            # 验证失败：已过期
            if ($secure_link = "0") {
                return 410; # Gone
            }

            # 内部映射到真实文件（不对外暴露）
            alias /var/www/private/uploads/;

            # 设置合适的 MIME 类型
            location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
                add_header Content-Type image/jpeg;
            }
            
            location ~* \.(pdf)$ {
                add_header Content-Type application/pdf;
            }

            # 可选：设置缓存头（对临时链接通常设为 no-cache）
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, private";
        }

        # 可选：禁止直接访问 /private/ 路径
        location /private/ {
            deny all;
            return 404;
        }

        # 健康检查（可选）
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}